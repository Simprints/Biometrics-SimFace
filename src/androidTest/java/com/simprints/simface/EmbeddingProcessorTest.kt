import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import androidx.test.core.app.ApplicationProvider
import androidx.test.ext.junit.runners.AndroidJUnit4
import com.simprints.biometrics_simface.R
import com.simprints.simface.core.SimFaceConfig
import com.simprints.simface.core.SimFaceFacade
import org.junit.Assert.assertArrayEquals
import org.junit.Test
import org.junit.Before
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class EmbeddingProcessorTest {
    private lateinit var simFace: SimFaceFacade
    private lateinit var context: Context

    @Before
    fun setup() {
        context = ApplicationProvider.getApplicationContext()
        val simFaceConfig = SimFaceConfig(context)
        SimFaceFacade.initialize(simFaceConfig)
        simFace = SimFaceFacade.getInstance()
    }

    @Test
    fun testGetEmbeddingWithRealBitmap() {
        val bitmap: Bitmap = BitmapFactory.decodeResource(context.resources, R.drawable.royalty_free_good_face)

        val result = simFace.embeddingProcessor.getEmbedding(bitmap)

        // Define the expected output for our image
        val expectedEmbeddingDouble = doubleArrayOf(0.12548121809959412, -0.17922769486904144, 0.059661634266376495, -0.0027151303365826607, 0.16050592064857483, -0.10739459097385406, 0.01382092572748661, -0.24861569702625275, 0.06709859520196915, -0.236683651804924, 0.07845541089773178, 0.03178008645772934, 0.053232885897159576, -0.06386305391788483, 0.020054906606674194, 0.027912557125091553, -0.15031221508979797, 0.2758362591266632, -0.17276506125926971, 0.1285295933485031, -0.19860464334487915, -0.022600390017032623, 0.0870022177696228, -0.13504447042942047, -0.04429195448756218, 0.09387717396020889, 0.05310855433344841, 0.09239569306373596, 0.04370472580194473, 0.09898691624403, -0.13355661928653717, 0.05572936683893204, -0.2735828161239624, -0.001998080173507333, 0.1845138818025589, 0.09349633008241653, 0.02528422698378563, 0.05956649035215378, -0.03078748658299446, -0.15696722269058228, -0.08708779513835907, -0.055163200944662094, 0.10690861195325851, 0.004579524975270033, -0.0937386155128479, -0.059935227036476135, -0.17223766446113586, -0.14170069992542267, 0.30814987421035767, 0.09072952717542648, 0.08606868982315063, 0.11460381746292114, 0.0795215368270874, 0.15852271020412445, -0.006429898086935282, 0.07170981168746948, 0.20359522104263306, 0.07003429532051086, -0.10976012796163559, -0.1394830346107483, 0.026644159108400345, 0.06674977391958237, -0.12132846564054489, -0.05589355155825615, 0.027275314554572105, 0.21746060252189636, -0.009985985234379768, 0.014018436893820763, 0.03388392925262451, -0.009249141439795494, -0.11008331179618835, -0.047250520437955856, -0.07149963080883026, 0.02968849241733551, -0.023389652371406555, 0.29237037897109985, 0.08425229787826538, 0.005821106489747763, -0.059628650546073914, -0.11682134866714478, -0.13779538869857788, 0.05327700451016426, -0.04008607566356659, 0.12025757133960724, -0.06095879524946213, -0.10963457077741623, -0.06362353265285492, -0.08987870067358017, -0.07080189138650894, 0.07128579169511795, -0.1318984478712082, -0.1517547369003296, -0.3302794098854065, -0.15495514869689941, -0.15479975938796997, 0.03903261572122574, -0.12637367844581604, 0.1864311695098877, -0.03170433267951012, 0.107588991522789, 0.058642953634262085, 0.13427692651748657, 0.09242496639490128, 0.22508002817630768, -0.07088078558444977, -0.04133930429816246, -0.14137990772724152, -0.045612286776304245, 0.2771849036216736, 0.09494078159332275, -0.12184523046016693, -0.00667424825951457, 0.04800744354724884, 0.002360747894272208, -0.04939744994044304, 0.07607557624578476, 0.008069922216236591, 0.08192885667085648, -0.07226627320051193, 0.16068017482757568, -0.14688299596309662, -0.0908515527844429, 0.09329346567392349, -0.052544403821229935, -0.036449071019887924, 0.10628771036863327, 0.05321061611175537, -0.24333401024341583, 0.12567788362503052, 0.08554066717624664, -0.09551861137151718, -0.05091467872262001, 0.024289395660161972, -0.1392642855644226, 0.0975029394030571, 0.015092341229319572, 0.15168043971061707, 0.012100178748369217, 0.0703376978635788, -0.002526754280552268, 0.027956243604421616, 0.07059258967638016, -0.015697557479143143, -0.02716568484902382, 0.037033263593912125, -0.086964450776577, 0.19733838737010956, 0.021222516894340515, -0.1775832176208496, 0.17194542288780212, -0.13732023537158966, 0.05761104077100754, 0.3461102247238159, -0.07385414838790894, -0.2138334959745407, -0.014193861745297909, -0.02613210305571556, -0.09844167530536652, 0.1767599880695343, -0.020252540707588196, 0.06679237633943558, 0.1116507351398468, 0.12186375260353088, -0.05857960134744644, -0.0740605816245079, 0.1006418988108635, 0.08372896164655685, -0.029675498604774475, 0.10152927041053772, -0.10662242025136948, 0.18287910521030426, 0.13480547070503235, -0.2778592109680176, -0.22544407844543457, 0.017691269516944885, -0.03399905562400818, -0.13948334753513336, 0.18718694150447845, 0.21827241778373718, -0.25309669971466064, 0.007026011124253273, -0.008340137079358101, 0.026157254353165627, 0.09045543521642685, -0.1905088722705841, -0.03561453893780708, -0.05127964913845062, 0.17257048189640045, -0.0809861272573471, 0.21895937621593475, 0.12082822620868683, 0.11858392506837845, -0.05513378605246544, 0.089267797768116, -0.11507584154605865, -0.1956324726343155, -0.03104405477643013, -0.07243003696203232, -0.05890810117125511, -0.06225479021668434, -0.06645441800355911, -0.05767018347978592, 0.1332986205816269, 0.13843727111816406, -0.10242521017789841, -0.030598638579249382, -0.12684673070907593, -0.1328449547290802, -0.24766509234905243, -0.012068009003996849, 0.1459159255027771, 0.07389410585165024, 0.04831019043922424, -0.29199275374412537, 0.07369866222143173, 0.15064378082752228, -0.08716316521167755, 0.07971183210611343, -0.08449101448059082, -0.1460237205028534, -0.046597883105278015, -0.18376439809799194, 0.13566716015338898, 0.12176975607872009, -0.026076659560203552, -0.1562626212835312, -0.0026151221245527267, 0.07024730741977692, -0.051340632140636444, -0.0949237272143364, -0.08332768082618713, 0.142232745885849, 0.18606016039848328, -0.0392119474709034, 0.04397328943014145, 0.04902530834078789, 0.09914052486419678, 0.03444335237145424, -0.08791844546794891, 0.1020021066069603, 0.013061363250017166, -0.18418404459953308, 0.11680187284946442, 0.025810793042182922, 0.06517420709133148, 0.08873985707759857, 0.05307978391647339, -0.23399043083190918, 0.02556031383574009, 0.11088164895772934, -0.06152026727795601, -0.1142858937382698, 0.02440612018108368, 0.10529997199773788, 0.07462535798549652, -0.041086915880441666, 0.14142341911792755, -0.0804072916507721, -0.0500498004257679, -0.07018221914768219, -0.191759392619133, 0.061306606978178024, -0.062339913100004196, -0.21056556701660156, -0.010996603406965733, 0.08483456075191498, 0.12006903439760208, -0.03910916671156883, -0.036185476928949356, -0.1456075757741928, 0.037874653935432434, -0.0805169939994812, -0.033980827778577805, 0.025039570406079292, 0.19579866528511047, -0.11742780357599258, 0.05657549947500229, -0.05586019158363342, -0.06144729629158974, -0.07748980075120926, 0.006294917315244675, 0.13713884353637695, -0.2031269520521164, -0.0629575252532959, -0.03030148334801197, -0.24608655273914337, -0.03825150057673454, -0.09234456717967987, 0.3190400302410126, 0.07127022743225098, 0.3222256004810333, 0.15071256458759308, 0.025934111326932907, -0.07468812167644501, -0.029399538412690163, -0.003380824811756611, -0.06259093433618546, 0.025075862184166908, -0.16740405559539795, -0.013439346104860306, 0.29901376366615295, 0.06459466367959976, -0.1432773619890213, 0.13462528586387634, 0.21012605726718903, 0.08576589822769165, 0.044529594480991364, -0.05891699716448784, -0.019798632711172104, -0.10582785308361053, 0.04081748053431511, -0.17863427102565765, -0.07370469719171524, 0.17566071450710297, 0.11077077686786652, 0.020078644156455994, 0.06876692175865173, -0.0410233773291111, -0.051761139184236526, -0.05064401030540466, -0.04421725124120712, -0.1718054711818695, -0.1314576268196106, 0.02840842865407467, 0.05828586220741272, 0.19972769916057587, 0.07767099887132645, -0.06816153228282928, -0.13355883955955505, -0.018223071470856667, 0.17618818581104279, -0.10021373629570007, 0.10106983780860901, -0.21889199316501617, -0.12433136999607086, -0.12342420965433121, -0.2202921211719513, 0.018270451575517654, 0.07801999896764755, -0.09427718073129654, -0.11523332446813583, -0.14098121225833893, 0.011964548379182816, -0.07153800874948502, -0.056906599551439285, 0.022803429514169693, 0.015549113042652607, 0.08966253697872162, 0.11428913474082947, -0.05484413728117943, -0.0641172006726265, 0.021535450592637062, 0.1281612515449524, 0.22486287355422974, -0.037256985902786255, -0.1709924042224884, -0.261284738779068, 0.08157172799110413, 0.19028310477733612, 0.2903730869293213, -0.02097168006002903, -0.09885413199663162, 0.12559615075588226, -0.11133743077516556, 0.03049856796860695, -0.19408296048641205, 0.028330335393548012, -0.17537492513656616, -0.1671239137649536, -0.0556357204914093, 0.02563321590423584, -0.007488544099032879, -0.027570031583309174, -0.14808428287506104, -0.03567482531070709, 0.07983710616827011, -0.10117322951555252, 0.2536829710006714, 0.10368222743272781, 0.21756909787654877, 0.20306019484996796, -0.08686430752277374, -0.0712965801358223, -0.0956614762544632, 0.0005898876115679741, 0.03637957572937012, -0.1964142620563507, 0.12420804053544998, 0.12846198678016663, -0.13901463150978088, -0.11660358309745789, 0.009191361255943775, -0.25605329871177673, -0.053380709141492844, -0.08589198440313339, 0.06467146426439285, 0.18386131525039673, -0.13970564305782318, -0.007629650179296732, -0.006988339126110077, 0.06135433167219162, -0.08921073377132416, 0.015021033585071564, 0.12284304201602936, -0.14149582386016846, -0.12852923572063446, 0.001896117813885212, 0.0953405424952507, -0.042282454669475555, 0.06624385714530945, 0.047639451920986176, -0.11811801046133041, -0.0684657171368599, -0.06131361797451973, 0.027308568358421326, 0.23214514553546906, 0.052793264389038086, 0.1259676069021225, -0.08738012611865997, -0.08891294151544571, -0.2518209218978882, -0.2067396193742752, 0.05133737996220589, -0.054194703698158264, -0.057396531105041504, -0.19743140041828156, -0.10027996450662613, 0.06716269254684448, 0.16923867166042328, -0.09371041506528854, 0.17089729011058807, 0.11445671319961548, 0.13094259798526764, 0.114357128739357, 0.10611556470394135, -0.04895756393671036, -0.19454799592494965, 0.17048530280590057, -0.1025635302066803, -0.11480765789747238, -0.04395730420947075, -0.17750760912895203, 0.05495148152112961, 0.09250980615615845, 0.19286949932575226, 0.10120350867509842, -0.18710987269878387, 0.03251037001609802, -0.02776355855166912, 0.001048574224114418, 0.08552752435207367, 0.06547610461711884, -0.15802918374538422, 0.09540070593357086, 0.001167916227132082, 0.02573200687766075, 0.1426645964384079, 0.06651795655488968, 0.2095434069633484, 0.09874886274337769, 0.03163629397749901, -0.06430759280920029, -0.14339378476142883, -0.02985837310552597, -0.2579661011695862, -0.18898352980613708, 0.05603976547718048, -0.16012834012508392, 0.05947684869170189, 0.09087489545345306, -0.03988175466656685, -0.2621832489967346, -0.01661500334739685, 0.20521970093250275, -0.011174194514751434, 0.05326782166957855, 0.004219600930809975, 0.08910233527421951, -0.17093166708946228, 0.08573982864618301, 0.19330094754695892, 0.11586462706327438, -0.026668189093470573, 0.029271407052874565, -0.11160067468881607, 0.018083631992340088, 0.0221986286342144, 0.07087381184101105, -0.003971777856349945, -0.21161343157291412, -0.03311038017272949, 0.09600488841533661, 0.06734137237071991, 0.12777793407440186, 0.08617755025625229, 0.09514907002449036, -0.11076955497264862, -0.023807542398571968, -0.11699671298265457, -0.0019760308787226677, 0.07244348526000977, 0.122728630900383, 0.10770643502473831, -0.10804560035467148, 0.022084858268499374, 0.21036073565483093, -0.08268687129020691, -0.0743890106678009, -0.04516490548849106, -0.08531370759010315, -0.0036158282309770584, 0.023427331820130348)
        val expectedEmbedding = expectedEmbeddingDouble.map { it.toFloat() }.toFloatArray()

        // Verify results
        assertArrayEquals(expectedEmbedding, result.toFloatArray(), 0.1f) // The delta here is quite large due to small difference in processing between desktop and mobile
    }
}
